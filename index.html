<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HP 10bII+ Financial Calculator</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback } = React;

        // Lucide Icons
        const Calculator = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="4" y="2" width="16" height="20" rx="2"/>
                <line x1="8" y1="6" x2="16" y2="6"/>
                <line x1="16" y1="10" x2="16" y2="10"/>
                <line x1="12" y1="10" x2="12" y2="10"/>
                <line x1="8" y1="10" x2="8" y2="10"/>
                <line x1="16" y1="14" x2="16" y2="14"/>
                <line x1="12" y1="14" x2="12" y2="14"/>
                <line x1="8" y1="14" x2="8" y2="14"/>
                <line x1="16" y1="18" x2="16" y2="18"/>
                <line x1="12" y1="18" x2="12" y2="18"/>
                <line x1="8" y1="18" x2="8" y2="18"/>
            </svg>
        );

        const TrendingUp = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="22,7 13.5,15.5 8.5,10.5 2,17"/>
                <polyline points="16,7 22,7 22,13"/>
            </svg>
        );

        const DollarSign = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        );

        const PieChart = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
            </svg>
        );

        const FileText = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 1 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10,9 9,9 8,9"/>
            </svg>
        );

        const FinancialCalculator = () => {
            const [display, setDisplay] = useState('0');
            const [mode, setMode] = useState('basic');
            const [memory, setMemory] = useState({});
            
            // TVM Variables
            const [tvmVars, setTvmVars] = useState({
                N: 0,    // Number of periods
                IYR: 0,  // Interest rate per year
                PV: 0,   // Present value
                PMT: 0,  // Payment
                FV: 0    // Future value
            });

            // Cash Flow Variables
            const [cashFlows, setCashFlows] = useState([]);

            // Amortization Variables
            const [amortVars, setAmortVars] = useState({
                principal: 0,
                rate: 0,
                payments: 0,
                payment: 0
            });
            const [amortSchedule, setAmortSchedule] = useState([]);
            const [showSchedule, setShowSchedule] = useState(false);

            const [lastOperation, setLastOperation] = useState('');

            // Basic calculator functions
            const inputNumber = (num) => {
                if (display === '0' || lastOperation === 'calculate') {
                    setDisplay(num.toString());
                } else {
                    setDisplay(display + num);
                }
                setLastOperation('input');
            };

            const inputDecimal = () => {
                if (!display.includes('.')) {
                    setDisplay(display + '.');
                }
            };

            const clear = () => {
                setDisplay('0');
                setLastOperation('');
            };

            const clearAll = () => {
                setDisplay('0');
                setLastOperation('');
                setMemory({});
                setTvmVars({ N: 0, IYR: 0, PV: 0, PMT: 0, FV: 0 });
                setCashFlows([]);
            };

            // TVM Calculations
            const solveTVM = (variable) => {
                const { N, IYR, PV, PMT, FV } = tvmVars;
                const i = IYR / 100 / 12; // Monthly interest rate
                
                try {
                    let result;
                    
                    switch (variable) {
                        case 'N':
                            if (i === 0) {
                                result = -(PV + FV) / PMT;
                            } else {
                                result = -Math.log(1 - (PV * i) / PMT) / Math.log(1 + i);
                            }
                            break;
                            
                        case 'IYR':
                            // Newton-Raphson method for solving interest rate
                            let guess = 0.1; // Start with 10% annual rate
                            for (let iter = 0; iter < 100; iter++) {
                                const monthlyRate = guess / 12;
                                const power = Math.pow(1 + monthlyRate, N);
                                
                                // Calculate present value of annuity and future value
                                const pvAnnuity = PMT * (1 - Math.pow(1 + monthlyRate, -N)) / monthlyRate;
                                const pvFuture = FV * Math.pow(1 + monthlyRate, -N);
                                const calc = PV + pvAnnuity + pvFuture;
                                
                                if (Math.abs(calc) < 0.001) break;
                                
                                // Derivative for Newton-Raphson
                                const dPvAnnuity = PMT * (N * Math.pow(1 + monthlyRate, -N-1) - (1 - Math.pow(1 + monthlyRate, -N)) / Math.pow(monthlyRate, 2)) / 12;
                                const dPvFuture = -N * FV * Math.pow(1 + monthlyRate, -N-1) / 12;
                                const derivative = dPvAnnuity + dPvFuture;
                                
                                if (Math.abs(derivative) < 0.000001) break;
                                guess = guess - calc / derivative;
                            }
                            result = guess * 100; // Convert to percentage
                            break;
                            
                        case 'PV':
                            if (i === 0) {
                                result = -(PMT * N + FV);
                            } else {
                                result = -(PMT * (1 - Math.pow(1 + i, -N)) / i + FV * Math.pow(1 + i, -N));
                            }
                            break;
                            
                        case 'PMT':
                            if (i === 0) {
                                result = -(PV + FV) / N;
                            } else {
                                result = -(PV * i + FV * i / (Math.pow(1 + i, N) - 1)) * (Math.pow(1 + i, N) - 1) / (1 - Math.pow(1 + i, -N));
                            }
                            break;
                            
                        case 'FV':
                            if (i === 0) {
                                result = -(PV + PMT * N);
                            } else {
                                result = -(PV * Math.pow(1 + i, N) + PMT * (Math.pow(1 + i, N) - 1) / i);
                            }
                            break;
                            
                        default:
                            return;
                    }
                    
                    setDisplay(result.toFixed(2));
                    setTvmVars(prev => ({ ...prev, [variable]: parseFloat(result.toFixed(2)) }));
                    setLastOperation('calculate');
                } catch (error) {
                    setDisplay('Error');
                }
            };

            // Store current display value to TVM variable
            const storeTVM = (variable) => {
                const value = parseFloat(display);
                setTvmVars(prev => ({ ...prev, [variable]: value }));
                setDisplay('0');
            };

            // Calculate NPV
            const calculateNPV = () => {
                const rate = parseFloat(display) / 100;
                let npv = 0;
                
                cashFlows.forEach((cf, index) => {
                    npv += cf / Math.pow(1 + rate, index);
                });
                
                setDisplay(npv.toFixed(2));
                setLastOperation('calculate');
            };

            // Calculate IRR
            const calculateIRR = () => {
                let rate = 0.1;
                
                for (let iter = 0; iter < 100; iter++) {
                    let npv = 0;
                    let dnpv = 0;
                    
                    cashFlows.forEach((cf, index) => {
                        npv += cf / Math.pow(1 + rate, index);
                        dnpv -= index * cf / Math.pow(1 + rate, index + 1);
                    });
                    
                    if (Math.abs(npv) < 0.01) break;
                    rate = rate - npv / dnpv;
                }
                
                setDisplay((rate * 100).toFixed(2));
                setLastOperation('calculate');
            };

            // Add cash flow
            const addCashFlow = () => {
                const value = parseFloat(display);
                setCashFlows(prev => [...prev, value]);
                setDisplay('0');
            };

            // Amortization functions
            const storeAmort = (variable) => {
                const value = parseFloat(display);
                setAmortVars(prev => ({ ...prev, [variable]: value }));
                setDisplay('0');
            };

            const calculateAmortPayment = () => {
                const { principal, rate, payments } = amortVars;
                const monthlyRate = rate / 100 / 12;
                
                if (monthlyRate === 0) {
                    const payment = principal / payments;
                    setAmortVars(prev => ({ ...prev, payment }));
                    setDisplay(payment.toFixed(2));
                } else {
                    const payment = principal * (monthlyRate * Math.pow(1 + monthlyRate, payments)) / (Math.pow(1 + monthlyRate, payments) - 1);
                    setAmortVars(prev => ({ ...prev, payment }));
                    setDisplay(payment.toFixed(2));
                }
                setLastOperation('calculate');
            };

            const generateAmortSchedule = () => {
                const { principal, rate, payments, payment } = amortVars;
                const monthlyRate = rate / 100 / 12;
                let balance = principal;
                const schedule = [];

                for (let i = 1; i <= payments; i++) {
                    const interestPayment = balance * monthlyRate;
                    const principalPayment = payment - interestPayment;
                    balance = balance - principalPayment;

                    schedule.push({
                        payment: i,
                        paymentAmount: payment,
                        principal: principalPayment,
                        interest: interestPayment,
                        balance: Math.max(0, balance)
                    });

                    if (balance <= 0) break;
                }

                setAmortSchedule(schedule);
                setShowSchedule(true);
                setDisplay(`${schedule.length} payments`);
                setLastOperation('calculate');
            };

            // Button component
            const Button = ({ children, onClick, className = '', isActive = false }) => (
                <button
                    onClick={onClick}
                    className={`
                        h-12 rounded border transition-all duration-150 font-semibold text-sm
                        ${isActive 
                            ? 'bg-blue-600 text-white border-blue-700' 
                            : 'bg-gray-100 hover:bg-gray-200 border-gray-300 text-gray-800'
                        }
                        active:scale-95 shadow-sm hover:shadow
                        ${className}
                    `}
                >
                    {children}
                </button>
            );

            const ModeButton = ({ mode: buttonMode, icon: Icon, label }) => (
                <Button
                    onClick={() => setMode(buttonMode)}
                    isActive={mode === buttonMode}
                    className="flex flex-col items-center justify-center p-2"
                >
                    <Icon />
                    <span className="text-xs mt-1">{label}</span>
                </Button>
            );

            return (
                <div className="max-w-md mx-auto bg-gray-900 p-6 rounded-xl shadow-2xl">
                    {/* Header */}
                    <div className="text-center mb-4">
                        <h1 className="text-white text-lg font-bold">HP 10bII+</h1>
                        <p className="text-gray-400 text-sm">Financial Calculator</p>
                    </div>

                    {/* Display */}
                    <div className="bg-gray-800 p-4 rounded-lg mb-4">
                        <div className="text-right text-white text-2xl font-mono bg-gray-700 p-3 rounded border-2 border-gray-600">
                            {display}
                        </div>
                        {mode === 'tvm' && (
                            <div className="mt-2 text-xs text-gray-300 grid grid-cols-5 gap-1">
                                <div>N: {tvmVars.N}</div>
                                <div>I/YR: {tvmVars.IYR}</div>
                                <div>PV: {tvmVars.PV}</div>
                                <div>PMT: {tvmVars.PMT}</div>
                                <div>FV: {tvmVars.FV}</div>
                            </div>
                        )}
                        {mode === 'cashflow' && (
                            <div className="mt-2 text-xs text-gray-300">
                                Cash Flows: [{cashFlows.join(', ')}]
                            </div>
                        )}
                        {mode === 'amort' && (
                            <div className="mt-2 text-xs text-gray-300 grid grid-cols-2 gap-2">
                                <div>Principal: {amortVars.principal}</div>
                                <div>Rate: {amortVars.rate}%</div>
                                <div>Payments: {amortVars.payments}</div>
                                <div>Payment: {amortVars.payment.toFixed(2)}</div>
                            </div>
                        )}
                    </div>

                    {/* Mode Selection */}
                    <div className="grid grid-cols-5 gap-2 mb-4">
                        <ModeButton mode="basic" icon={Calculator} label="Basic" />
                        <ModeButton mode="tvm" icon={TrendingUp} label="TVM" />
                        <ModeButton mode="cashflow" icon={DollarSign} label="CF" />
                        <ModeButton mode="bond" icon={PieChart} label="Bond" />
                        <ModeButton mode="amort" icon={FileText} label="Amort" />
                    </div>

                    {/* Function Buttons Based on Mode */}
                    {mode === 'tvm' && (
                        <div className="grid grid-cols-5 gap-2 mb-4">
                            <Button onClick={() => storeTVM('N')} className="text-xs">N</Button>
                            <Button onClick={() => storeTVM('IYR')} className="text-xs">I/YR</Button>
                            <Button onClick={() => storeTVM('PV')} className="text-xs">PV</Button>
                            <Button onClick={() => storeTVM('PMT')} className="text-xs">PMT</Button>
                            <Button onClick={() => storeTVM('FV')} className="text-xs">FV</Button>
                        </div>
                    )}

                    {mode === 'tvm' && (
                        <div className="grid grid-cols-5 gap-2 mb-4">
                            <Button onClick={() => solveTVM('N')} className="text-xs bg-blue-100">Calc N</Button>
                            <Button onClick={() => solveTVM('IYR')} className="text-xs bg-blue-100">Calc I</Button>
                            <Button onClick={() => solveTVM('PV')} className="text-xs bg-blue-100">Calc PV</Button>
                            <Button onClick={() => solveTVM('PMT')} className="text-xs bg-blue-100">Calc PMT</Button>
                            <Button onClick={() => solveTVM('FV')} className="text-xs bg-blue-100">Calc FV</Button>
                        </div>
                    )}

                    {mode === 'cashflow' && (
                        <div className="grid grid-cols-3 gap-2 mb-4">
                            <Button onClick={addCashFlow} className="text-xs">Add CF</Button>
                            <Button onClick={calculateNPV} className="text-xs bg-green-100">NPV</Button>
                            <Button onClick={calculateIRR} className="text-xs bg-green-100">IRR</Button>
                        </div>
                    )}

                    {mode === 'amort' && (
                        <>
                            <div className="grid grid-cols-4 gap-2 mb-2">
                                <Button onClick={() => storeAmort('principal')} className="text-xs">Principal</Button>
                                <Button onClick={() => storeAmort('rate')} className="text-xs">Rate %</Button>
                                <Button onClick={() => storeAmort('payments')} className="text-xs"># Pmts</Button>
                                <Button onClick={() => storeAmort('payment')} className="text-xs">Payment</Button>
                            </div>
                            <div className="grid grid-cols-3 gap-2 mb-4">
                                <Button onClick={calculateAmortPayment} className="text-xs bg-blue-100">Calc PMT</Button>
                                <Button onClick={generateAmortSchedule} className="text-xs bg-green-100">Schedule</Button>
                                <Button onClick={() => setShowSchedule(!showSchedule)} className="text-xs bg-gray-200">
                                    {showSchedule ? 'Hide' : 'Show'}
                                </Button>
                            </div>
                        </>
                    )}

                    {/* Number Pad */}
                    <div className="grid grid-cols-4 gap-2">
                        {/* Row 1 */}
                        <Button onClick={clearAll} className="bg-red-100 text-red-800">C</Button>
                        <Button onClick={clear} className="bg-yellow-100">CE</Button>
                        <Button onClick={() => setDisplay(display.slice(0, -1) || '0')}>⌫</Button>
                        <Button onClick={() => setDisplay((parseFloat(display) * -1).toString())}>±</Button>

                        {/* Row 2 */}
                        <Button onClick={() => inputNumber(7)}>7</Button>
                        <Button onClick={() => inputNumber(8)}>8</Button>
                        <Button onClick={() => inputNumber(9)}>9</Button>
                        <Button onClick={() => setDisplay(Math.sqrt(parseFloat(display)).toString())}>√</Button>

                        {/* Row 3 */}
                        <Button onClick={() => inputNumber(4)}>4</Button>
                        <Button onClick={() => inputNumber(5)}>5</Button>
                        <Button onClick={() => inputNumber(6)}>6</Button>
                        <Button onClick={() => setDisplay(Math.pow(parseFloat(display), 2).toString())}>x²</Button>

                        {/* Row 4 */}
                        <Button onClick={() => inputNumber(1)}>1</Button>
                        <Button onClick={() => inputNumber(2)}>2</Button>
                        <Button onClick={() => inputNumber(3)}>3</Button>
                        <Button onClick={() => setDisplay((1 / parseFloat(display)).toString())}>1/x</Button>

                        {/* Row 5 */}
                        <Button onClick={() => inputNumber(0)} className="col-span-2">0</Button>
                        <Button onClick={inputDecimal}>.</Button>
                        <Button onClick={() => setDisplay((parseFloat(display) / 100).toString())}>%</Button>
                    </div>

                    {/* Amortization Schedule Display */}
                    {mode === 'amort' && showSchedule && amortSchedule.length > 0 && (
                        <div className="mt-4 bg-gray-800 rounded-lg p-4 max-h-64 overflow-y-auto">
                            <h3 className="text-white text-sm font-semibold mb-2">Amortization Schedule</h3>
                            <div className="text-xs">
                                <div className="grid grid-cols-5 gap-1 text-gray-300 font-semibold mb-1 sticky top-0 bg-gray-800">
                                    <div>#</div>
                                    <div>Payment</div>
                                    <div>Principal</div>
                                    <div>Interest</div>
                                    <div>Balance</div>
                                </div>
                                {amortSchedule.slice(0, 20).map((row, index) => (
                                    <div key={index} className="grid grid-cols-5 gap-1 text-gray-100 py-1 border-b border-gray-700">
                                        <div>{row.payment}</div>
                                        <div>{row.paymentAmount.toFixed(2)}</div>
                                        <div>{row.principal.toFixed(2)}</div>
                                        <div>{row.interest.toFixed(2)}</div>
                                        <div>{row.balance.toFixed(2)}</div>
                                    </div>
                                ))}
                                {amortSchedule.length > 20 && (
                                    <div className="text-gray-400 text-center mt-2">
                                        Showing first 20 of {amortSchedule.length} payments
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Instructions */}
                    <div className="mt-4 text-xs text-gray-400 text-center">
                        {mode === 'tvm' && 'Enter values, store with variable buttons, then calculate unknown variable'}
                        {mode === 'cashflow' && 'Enter cash flows, add with "Add CF", then calculate NPV or IRR'}
                        {mode === 'basic' && 'Basic calculator operations'}
                        {mode === 'bond' && 'Bond calculations (coming soon)'}
                        {mode === 'amort' && 'Enter loan details, calculate payment, then generate amortization schedule'}
                    </div>

                    {/* Footer */}
                    <div className="mt-6 text-center">
                        <p className="text-gray-500 text-xs">
                            Open Source Financial Calculator • 
                            <a href="https://github.com/yourusername/hp-10bii-calculator" className="text-blue-400 hover:text-blue-300 ml-1">
                                View on GitHub
                            </a>
                        </p>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<FinancialCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
